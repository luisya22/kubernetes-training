{
  "id": "exercise-statefulsets",
  "lessonId": "advanced-statefulsets",
  "title": "Deploy a Stateful Application",
  "description": "Create a StatefulSet with persistent storage and stable network identities",
  "difficulty": "advanced",
  "estimatedTime": 35,
  "steps": [
    {
      "id": "step-1",
      "order": 1,
      "instruction": "Create a headless Service named 'db-service' for a StatefulSet",
      "expectedOutcome": "Headless service should be created (ClusterIP: None)",
      "hints": [
        "A headless service has clusterIP: None",
        "This provides stable DNS entries for each pod",
        "Use selector to match the StatefulSet pods"
      ],
      "validation": {
        "type": "kubernetes",
        "checks": [
          {
            "command": "kubectl get service db-service -o jsonpath='{.spec.clusterIP}'",
            "expectedOutput": "None"
          }
        ]
      }
    },
    {
      "id": "step-2",
      "order": 2,
      "instruction": "Create a StatefulSet named 'database' with 3 replicas, using the headless service, with a volumeClaimTemplate requesting 1Gi storage",
      "expectedOutcome": "StatefulSet should create 3 pods with persistent volumes",
      "hints": [
        "StatefulSets create pods with predictable names: database-0, database-1, database-2",
        "Each pod gets its own PVC from the volumeClaimTemplate",
        "Use serviceName to reference the headless service"
      ],
      "validation": {
        "type": "kubernetes",
        "checks": [
          {
            "command": "kubectl get statefulset database -o jsonpath='{.spec.replicas}'",
            "expectedOutput": "3"
          },
          {
            "command": "kubectl get statefulset database -o jsonpath='{.status.readyReplicas}'",
            "expectedOutput": "3"
          }
        ]
      }
    },
    {
      "id": "step-3",
      "order": 3,
      "instruction": "Clean up by deleting the StatefulSet and its associated resources.",
      "expectedOutcome": "StatefulSet should be deleted",
      "hints": [
        "Delete the StatefulSet: kubectl delete statefulset web",
        "Delete the Service: kubectl delete service nginx",
        "Note: PVCs may need to be deleted separately if you want to remove all data",
        "Verify: kubectl get statefulsets,services"
      ],
      "validation": {
        "type": "kubernetes",
        "checks": [
          {
            "command": "kubectl get statefulset web 2>&1 | grep -q \"NotFound\" && echo \"deleted\" || echo \"exists\"",
            "expectedOutput": "deleted"
          }
        ]
      }
    }
  ],
  "resources": [
    {
      "type": "yaml",
      "name": "statefulset.yaml",
      "content": "apiVersion: v1\nkind: Service\nmetadata:\n  name: db-service\nspec:\n  clusterIP: None\n  selector:\n    app: database\n  ports:\n  - port: 80\n---\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: database\nspec:\n  serviceName: db-service\n  replicas: 3\n  selector:\n    matchLabels:\n      app: database\n  template:\n    metadata:\n      labels:\n        app: database\n    spec:\n      containers:\n      - name: nginx\n        image: nginx:latest\n        volumeMounts:\n        - name: data\n          mountPath: /data\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes: [\"ReadWriteOnce\"]\n      resources:\n        requests:\n          storage: 1Gi"
    }
  ]
}
